<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>cloud_detail</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    a {
      text-decoration: none; /* 去除下划线 */
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* 创建一个整体的容器，使用flex布局 */
    .container { }

    /* 头部区域 */
    header {
      background-color: var(--header-color);
      height: 60px;
      width: 100%;
      color: white;
      text-align: center;
      line-height: 60px;
    }

    header .content {
      margin: auto;
      width: 800px;
      height: 100%;
    }

    header .logo {
      float: left;
      margin-top: 5px;
    }

    header .logo img {
      height: 50px;
    }

    header .block {
      float: right;
      margin-left: 20px;
      width: 100px;
      background-color: var(--header-block-color);
    }
    header .block a{
      font-size: 20px;
      color: var(--header-bolck-fcolor);
      font-weight: bolder;
    }
    /*hover*/
    header .block :hover{
      float: right;
      margin-left: 20px;
      width: 100px;
      background-color: var(--header-block-hover-color);
    }
    /* 激活状态 */
    .block.active {
      background-color: var(--header-block-hover-color);
      color: white;
    }

    /* 中间内容部分，指定固定的长宽并居中 */
    main {
      margin: auto;
      background-color: #f8f8f8;
      width: 800px;
    }


    main .mainTitle{
      height: 100px;
      width: 800px;
      margin: auto;
      display: flex;
      justify-content: center; /* 水平居中对齐 */
      align-items: center;     /* 垂直居中对齐 */
      text-align: center;
      font-size: 50px;
      font-weight: bolder;
      background-color: var(--main-title-color);
      color:var(--main-title-fcolor);
    }

    main .cloudinfo {
      /*height: 600px;*/
      margin-top: 20px;

      /*background-color: #377060;*/
    }
    main .cloudinfo  .cloudImg {
      width: 800px;

      /*background-color: #d4eb7b;*/
    }
    main .cloudinfo img {
      width: 800px;

      background-color: #404238;
    }
    main .cloudinfo .cloudtext{
      /*height: 100px;*/

      font-size: 30px;
      font-weight: lighter;
      background-color: #e7edf0;
    }

    /* 底部区域 */
    footer {
      background-color: var(--footer-color);
      height: 300px;
      width: 100%;
      text-align: center;
      line-height: 60px;
      margin-top: auto;
      padding-top: 50px;
    }
    footer .creatorLogo {
      width: 100%;
      height: 70px;
      /*margin-left:auto;*/
      /*margin-top: 20px;*/
      /*background-color: #fff;*/
    }

    footer .creatorLogo img {
      height: 70px;
    }
    footer .creatorInfo{
      height: 100px;
      width: 100%;
      margin-top: 20px;
      text-align: center;
      line-height: 20px;
      font-size: 25px;
      font-weight: lighter;
      color: var(--footer-fcolor);
      /*background-color: rgba(255, 255, 255, 0.51);*/
    }

    /*查看大图*/
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      padding-top: 100px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.9);
    }

    .modal-content {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 700px;
    }

    .close {
      position: absolute;
      top: 20px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
    }

    .close:hover,
    .close:focus {
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
    }



  /*  post样式*/
    .postContainer {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .meinfo {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background-color: #f0fff3;
    }

    .profile_pic {
      float: left;
      width: 100px;
      height: 100px;
      margin: 10px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid #53e4bd;
    }

    .profile_name {
      margin-left: 35px;
      font-size: 26px;
      font-weight: bold;
      color: #333333;
    }

    .post_pic {
      width: 100%;
      height: 400px;
      background-size: cover;
      background-position: center;
      border-radius: 8px;
    }

    .post_text {
      padding: 10px;
      margin: 10px;
      font-size: 20px;
      color: #555555;
      background-color: #e1e7e8;
      line-height: 1.5;
    }
    .create_time{
      float: right;
      height: 30px;
      width: 210px;
      margin-top:80px;
      background-color: rgba(255, 255, 255, 0.35);
    }
    .comment_section {
      margin-top: 32px;
    }

    .comment-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      background-color: #f1e7d9;
    }

    .comment-item .profile_pic {
      float: left;
      margin: 10px;
      width: 40px;
      height: 40px;
    }

    .comment-item .profile_name {
      float: left;
      margin: 10px;
      margin-top: 18px;
      font-size: 20px;
      font-weight: 600;
      color: #444444;
    }

    .comment-item .comment_text {
      float: left;
      width: 700px;
      margin-left: 10px;
      margin-top: 20px;
      margin-bottom: 10px;
      padding: 10px;
      font-size: 20px;
      color: #2e4047;
      font-weight: bolder;
      background-color: #cfebeb;
    }


    /*帖子多图处理*/
    .post_pic .button {

      background-color: #333;
      color: white;
      border: none;
      margin-top: 200px;
      /*padding: 10px 15px;*/
      font-size: 30px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      /*position: absolute;*/
      /*top: 50%;*/
      /*transform: translateY(-50%);*/
      /*z-index: 1; !* 确保按钮显示在图片上方 *!*/
      z-index: 100;
    }

    /* 鼠标悬停在按钮上的效果 */
    .post_pic .button:hover {
      background-color: #555;
    }

    /* 左按钮的位置 */
    .left {
      float:left;
      margin-left: 10px;
    }

    /* 右按钮的位置 */
    .right {
      float:right;
      margin-right: 10px;
    }


    div[id^="currentImgNumBox_"] {
      width: 80px;
      height: 50px;
      float: right;

      margin-left: 700px;
      margin-top: 10px;
      background-color: rgb(122, 191, 223);
      /*position: fixed;*/
      /*top: 90%;*/
      /*left: 90%;*/
      color: white;
      /*border: none;*/
      /*padding: 10px;*/
      z-index: 1000;

      font-weight: bolder;
      font-size: larger;
    }


    .post_like{
      float: right;
      height: 50px;
      width: 100px;
      margin-left: 650px;
      margin-top: 20px;
      /*background-color: #cce9d0;*/
      color: white;
    }

    .post_like .like_num_post{
      float: right;
      height: 50px;
      width: 50px;
      color: #031a42;
      font-size: 25px;
      font-weight: bolder;
      line-height: 50px;
    }
    .post_like .like_btn{
      float: right;
      height: 50px;
      width: 50px;
      border-radius: 50%;
      background-color: rgba(109, 200, 227, 0.52);
      cursor: pointer; /* 添加此属性以更改鼠标样式 */

      font-size: 25px;
      font-weight: bolder;
      line-height: 50px;

    }



    main .comment_section .comment_like{
      float: right;
      height: 20px;
      width: 50px;
      margin-right: 40px;
      margin-top: 10px;
      margin-bottom: 10px;
      color: white;
    }
    main .comment_section .comment_like .like_btn{
      float: left;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background-color: rgba(109, 200, 227, 0.52);
      cursor: pointer; /* 添加此属性以更改鼠标样式 */
    }

    main .comment_section .comment_like .like_num_comment{
      float: right;
      height: 20px;
      width: 20px;
      color: #031a42;
      line-height: 20px;
      font-size: 20px;
    }

    .post_comment{
      float: left;
      height: 20px;
      width: 720px;
      margin-left: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
      background-color: rgba(242, 251, 251, 0.56);
    }


    /* 整体评论区域样式 */
    .post_comment {
      margin-top: 20px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 评论表单样式 */
    .commentForm {
      height: 20px;
      width: 720px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* 评论输入框样式 */
    .commentForm input[type="text"] {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background-color: #fff;
      outline: none;
      transition: border-color 0.3s ease;
    }

    .commentForm input[type="text"]:focus {
      border-color: #007bff;
    }

    /* 提交按钮样式 */
    .commentForm input[type="submit"] {
      float: right;
      width: 100px;
      padding: 8px 16px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    .commentForm input[type="submit"]:hover {
      background-color: #0056b3;
    }

    /* 隐藏的输入框样式 */
    .commentForm input[type="hidden"] {
      display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="content">
      <div class="logo">
        <a href="/index">
          <img src="/images/logo.png" alt="Cloud Website Logo">
        </a>
      </div>
      <div id="me" class="block">
        <a href="/me">me</a>
      </div>
      <div id="classify" class="block">
        <a href="/classify">classify</a>
      </div>
      <div id="forum" class="block">
        <a href="/forum">forum</a>
      </div>
      <div id="know" class="block">
        <a href="/know">know</a>
      </div>
    </div>
  </header>
  <main>
    <div class="mainTitle" ><p></p></div>
    <div id="myModal" class="modal">
      <span class="close" onclick="closeModal()">&times;</span>
      <img class="modal-content" id="img01">
    </div>

    <div class="postContainer">
        <div class="meinfo">
<!--          <div class="profile_pic" id="profile_pic" th:style="'background: #53e4bd url(' + '\'' + '/images/profiles/' + ${post.userId} + '.jpg'+'\'' + ') no-repeat center center;'"></div>-->
<!--          <div class="profile_name" th:text="${post.userName}"></div>-->
<!--          <div class="post_pic" th:style="'background: #53e4bd url(' + '\'' + '/images/' + ${post.postImgPath} + '\'' + ') no-repeat center center;'"></div>-->
<!--          <div class="post_text" th:text="${post.postText}"></div>-->
<!--          <div class="post_like" data-postId="${post.postId}">-->
<!--            <div class="like_btn" onclick="likePost('${post.postId}')">👍</div>-->
<!--            <div class="like_num_post">${post.postLike}</div>-->
<!--          </div>-->
        </div>
        <div class="comment_section">
<!--          <div class="comment-item" th:each="comment:${comments}" th:if="${comment.postId} == ${post.postId}">-->
<!--            <div class="userinfo">-->
<!--              <div class="profile_pic" th:style="'background: #53e4bd url(' + '\'' + '/images/profiles/' + ${comment.userId} + '.jpg'+'\'' + ') no-repeat center center;'"></div>-->
<!--              <div class="profile_name" th:text="${comment.userName}"></div>-->
<!--              <div class="comment_text" th:text="${comment.commentText}"></div>-->
    <!--          <div class="comment_like" th:attr="data-commentId=${comment.commentId}">-->
    <!--            <div class="like_btn" th:attr="onclick=|likeComment('${comment.commentId}')|">👍</div>-->
    <!--            <div class="like_num_comment" th:text="${comment.commentLike}"></div>-->
    <!--          </div>-->
<!--            </div>-->
<!--          </div>-->
        </div>

    </div>

  </main>
  <footer>
    <div class="creatorLogo">
      <img src="/images/creatorLogo.jpg">
    </div>
    <div class="creatorInfo">
      <p>CREATOR:TAN</p>
      <p>EMAIL:tanyawen2640@gmail.com</p>
      <p>PHONE:13527800350</p>
    </div>
  </footer>
</div>
<script th:inline="javascript">
  /*<![CDATA[*/
  var postId = /*[[${session.postId}]]*/ null;  // 获取 session 中的 postId
  /*<![CDATA[*/
  var userLogin = /*[[${session.userLogin}]]*/ null;
  // JavaScript 示例
  window.onload = function() {
    // 获取当前页面的文件名
    const currentPage = window.location.pathname.split("/").pop().replace('.html', '');

    // 根据文件名给对应的块添加 active 类
    const activeBlock = document.getElementById(currentPage);
    if (activeBlock) {
      activeBlock.classList.add('active');
    }
  };

  //全局变量
  //currentIndex
  let currentIndex=0;
  //post的图片的数量
  let lenOfPostsImgs=0;

  function initLenOfPostsImgs(post){
    lenOfPostsImgs=post.postImgPaths.length;
  }


  // 页面加载时检查是否有JWT，如果没有则重定向到登录页
  window.onload = function() {
    const token = localStorage.getItem('authToken');
    console.log(token);
    if (token==='null') {
      alert('未登录,无jwt令牌.');
      window.location.href = '/toLogin';  // 未登录时跳转到登录页面
    } else {

      // 如果有JWT，则可以继续加载页面内容
      loadDetail(token);
    }
  };

  function loadImgIndex(postId){
    index=currentIndex+1;
    total=lenOfPostsImgs;
    const currentImgNumBox = document.getElementById('currentImgNumBox_'+postId);
    console.log('currentImgNumBox_'+postId);
    currentImgNumBox.textContent=index+"/"+total;
  }
  //切换图片
  function changeImg(btnId,post){
    if(lenOfPostsImgs==1){
      return;
    }
    console.log("~~~~~~~~~~~~~~~~~~~changeImg");
    const str = btnId;
    const direction=str.substring(0,4);
    console.log("direction:"+direction);
    const parts = str.split("_");
    if (parts.length > 1) {
      const postIndex = parseInt(parts[1], 10)-1;
      console.log(postIndex);
      console.log(direction);

      if (direction === 'prev') {
        newIndex = (currentIndex - 1 + lenOfPostsImgs) % lenOfPostsImgs;
      } else {
        newIndex = (currentIndex + 1) % lenOfPostsImgs;
      }
      currentIndex= newIndex;
      console.log("newIndex:"+currentIndex);
      // 更新图片的背景图，这里简单假设图片路径的规律，可根据实际情况修改
      const postPic = document.getElementById(`post_pic`);
      console.log("更改前："+postPic.style);
      if (postPic) {
        // <div id="post_pic_${post.postId}" class="post_pic" onclick="openModal('/images/${post.postImgPaths[postImgIndexList[postId-1]]}')"  style="background: #53e4bd url('/images/${post.postImgPaths[postImgIndexList[postId-1]]}') no-repeat center center;">

        //更改样式
        postPic.style = `background: #53e4bd url('/images/${post.postImgPaths[currentIndex]}') no-repeat center center;`;
        //更改onclick
        postPic.onclick = () => openModal(`/images/${post.postImgPaths[currentIndex]}`);
      }

      //更改index/total
      loadImgIndex(postIndex+1);

      console.log("更改后："+postPic.style);
    }


  }
  // 加载Post内容
  function loadDetail(token) {
    console.log(loadDetail);
    fetch(`/post/getPostDetail?postId=${postId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`  // 确保你有正确的 token
      }
    })
            .then(response => response.json())
            .then(data => {
              // 检查返回的 data 是否包含期望的结构
              if (data.code === 1 && null!=data.data) {
                const post = data.data;
                initLenOfPostsImgs(post);
                // 生成帖子部分
                const meinfo = document.querySelector(".meinfo");
                const isUserLoggedIn = userLogin !== null;
                meinfo.innerHTML = `

                      <div class="profile_pic" style="background: #53e4bd url('/images/${post.userProfilePath}') no-repeat center center; background-size: cover;"></div>
                      <div class="profile_name">${post.userName}</div>
                      <div class="post_pic" id="post_pic" style="background: #53e4bd url('/images/${post.postImgPaths[0]}') no-repeat center center; background-size: cover;">
                        <button class="button left" id="prevButton_${post.postId}">&lt;</button>
                        <button class="button right" id="nextButton_${post.postId}">&gt;</button>
                      </div>
                      <div class="currentImgNumBox" id="currentImgNumBox_${post.postId}">${currentIndex+1}/${lenOfPostsImgs}</div>
                      <div class="post_text">${post.postText}
                            <div class="create_time">${post.createTime}</div>
                      </div>

                      <div class="post_comment" style="display: ${isUserLoggedIn ? 'block' : 'none'};">
                        <form id="commentForm_${post.postId}" class="commentForm">
                            <input type="hidden" name="userId" id="userId" value="${userLogin ? userLogin.userId : ''}">
                            <input type="hidden" name="postId" id="postId" value="${post.postId}">
                            <input type="text" name="commentText" id="commentText" placeholder="Write your comment" style="border: none; background-color: transparent; outline: none;">
                            <input type="submit" value="提交评论" data-postId="${post.postId}">
                        </form>
                      </div>

                      <div class="post_like" data-postId="${post.postId}">
                        <div class="like_btn" onclick="likePost('${post.postId}')">👍</div>
                        <div class="like_num_post">${post.postLike}</div>
                      </div>
                `;


                //更改index/total
                loadImgIndex(post.postId);
                //为每一个post的按钮添加监听
                // 选择所有按钮
                const allButtons = meinfo.querySelectorAll('button');

                // 为每个按钮添加点击事件监听
                allButtons.forEach(button => {
                  button.addEventListener('click', function (event) {
                    event.stopPropagation();
                    console.log(`按钮 ${this.id} 被点击了`);
                    changeImg(this.id,post);

                  });
                });


                //提交评论处form监听
                const commentForms = document.querySelectorAll('.commentForm');
                commentForms.forEach(form => {
                  form.addEventListener('submit', async function (event) {
                    event.preventDefault(); // 阻止默认表单提交行为
                    console.log("~~~~~~~~~~~formid:"+form.id);
                    const token = localStorage.getItem('authToken');  // 获取本地存储中的token
                    // 获取提交按钮元素
                    const submitButton = event.submitter;

                    const userId = document.querySelector('#userId').value;
                    const postId = submitButton.getAttribute('data-postid');
                    // const commentText = document.querySelector('#commentText').value;

                    const commentText = form.querySelector('input[name="commentText"]').value;

                    console.log("postId:"+postId+" userId:"+userId+" commentText:"+commentText);
                    // 创建请求体
                    const requestBody = {
                      userId: userId,
                      postId: postId,
                      commentText: commentText
                    };
                    console.log("发送评论"+requestBody);
                    try {
                      // 发送 Fetch 请求
                      const response = await fetch('/post/submitComment', {
                        method: 'POST',
                        headers: {
                          'Authorization': `Bearer ${token}`,  // 设置 Authorization 头
                          'Content-Type': 'application/json'  // 发送 JSON 数据
                        },
                        body: JSON.stringify(requestBody)  // 将数据转为 JSON 字符串
                      });
                      console.log()
                      // 检查响应状态
                      if (!response.ok) {
                        throw new Error('网络响应失败');
                      }

                      // 解析返回的 JSON 数据
                      const result = await response.json();
                      console.log(result);
                      // 根据返回的 Result 封装信息处理
                      if (result.code === 1) {
                        // 评论成功
                        loadDetail(token);
                        alert("评论已发送！");
                      } else {
                        alert(result.msg);
                      }
                    } catch (error) {
                      alert("评论失败");
                    }

                  })
                });

                loadComments(token,postId);



              } else {
                console.error('Invalid data structure:', data);
              }
            })
            .catch(error => {
              console.error('Error loading cloud types:', error);
            });
  }

  // 加载Comments内容
  function loadComments(token,postId) {
    console.log("loadComments");
    fetch(`/post/getCommentsByPostId?postId=${postId}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`  // 确保你有正确的 token
      }
    })
            .then(response => response.json())
            .then(data => {
              // 检查返回的 data 是否包含期望的结构
              if (data.code === 1 && null!=data.data) {
                const commentSection = document.querySelector(".comment_section");
                // 清空现有的评论内容
                commentSection.innerHTML = "";

                // 遍历评论数据并生成 HTML
                data.data.forEach(comment => {
                  console.log(comment.postId+"  "+postId);
                  if (comment.postId.toString() === postId.toString()) {
                    console.log("comment.postId === postId");
                    const commentItem = `
                        <div class="comment-item">
                          <div class="userinfo">
                            <div class="profile_pic" style="background: #53e4bd url('/images/profiles/${comment.userId}.jpg') no-repeat center center; background-size: cover;"></div>
                            <div class="profile_name">${comment.userName}</div>
                            <div class="comment_text">${comment.commentText}</div>
                             <div class="comment_like" data-commentId="${comment.commentId}">
                                <div class="like_btn" onclick="likeComment('${comment.commentId}')">👍</div>
                                <div class="like_num_comment">${comment.commentLike}</div>
                             </div>
                          </div>
                        </div>
                    `;
                    commentSection.innerHTML += commentItem;
                  }
                });
              } else {
                console.error('Invalid data structure:', data);
              }
            })
            .catch(error => {
              console.error('Error loading cloud types:', error);
            });
  }



  // 查看大图
  function openModal(imageUrl) {
    console.log("openModal:"+imageUrl);
    var modal = document.getElementById("myModal");
    var modalImg = document.getElementById("img01");
    modal.style.display = "block";
    modalImg.src = imageUrl;
  }

  function closeModal() {
    var modal = document.getElementById("myModal");
    modal.style.display = "none";
  }


  //点赞
  function likePost(postId) {
    console.log("likePost")
    const token = localStorage.getItem('authToken');  // 获取本地存储中的token
    console.log("addEventListener:token"+token)
    fetch('/post/likePost/' + postId, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,  // 设置 Authorization 头
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code===1&& null!=data.data) {
                const postLikeElement = document.querySelector(`.post_like[data-postId='${postId}'] .like_num_post`);
                if (postLikeElement) {
                  console.log("更新post点赞数据")
                  postLikeElement.textContent = data.data;
                }
              } else{
                alert(data.msg);
              }
            })
            .catch(error => console.error('Error:', error));
  }

  //点赞
  function likeComment(commentId) {
    console.log("likeComment")
    const token = localStorage.getItem('authToken');  // 获取本地存储中的token

    console.log("addEventListener:token"+token)
    fetch('/post/likeComment/' + commentId, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,  // 设置 Authorization 头
        'Content-Type': 'application/json'
      }
    })
            .then(response => response.json())
            .then(data => {
              if (data.code===1&& null!=data.data) {
                // 更新点赞数显示，假设 class="post_like" 是显示点赞数的元素
                // document.querySelector('.like_num_comment').textContent =  data.newLikeCount;
                const commentLikeElement = document.querySelector(`.comment_like[data-commentId='${commentId}'] .like_num_comment`);
                if (commentLikeElement) {
                  commentLikeElement.textContent = data.data;
                }
              } else {
                alert(data.msg);
              }
            })
            .catch(error => console.error('Error:', error));
  }





</script>
</body>
</html>